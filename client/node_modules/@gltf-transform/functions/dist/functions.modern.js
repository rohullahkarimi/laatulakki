import{Primitive as e,PropertyType as t,Document as n,getBounds as o,Scene as r,PrimitiveTarget as s,MathUtils as i,BufferUtils as a,Root as c,TextureInfo as l,Texture as g,ExtensionProperty as u,AnimationChannel as f,Accessor as p,ImageUtils as m,ComponentTypeToTypedArray as d,TextureChannel as h,Material as A,Node as T,ColorUtils as y,AnimationSampler as E,uuid as S}from"@gltf-transform/core";import{getPixels as M,savePixels as I}from"ndarray-pixels";import{KHRMeshQuantization as w,KHRDracoMeshCompression as b,EXTMeshGPUInstancing as N,EXTMeshoptCompression as R,KHRMaterialsIOR as C,KHRMaterialsSpecular as O,KHRMaterialsPBRSpecularGlossiness as $,EXTTextureWebP as v,EXTTextureAVIF as P,KHRMaterialsUnlit as x}from"@gltf-transform/extensions";import{read as L,KHR_DF_MODEL_ETC1S as z,KHR_DF_MODEL_UASTC as F}from"ktx-parse";import _ from"ndarray";import{lanczos3 as G,lanczos2 as k}from"ndarray-lanczos";function q(){return q=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},q.apply(this,arguments)}function B(e,t){return Object.defineProperty(t,"name",{value:e}),t}function U(e,t,n){return!!e&&e.stack.lastIndexOf(t)<e.stack.lastIndexOf(n)}async function W(e,t,n){if(!e)return null;const o=e.getImage();if(!o)return null;const r=await M(o,e.getMimeType());for(let e=0;e<r.shape[0];++e)for(let t=0;t<r.shape[1];++t)n(r,e,t);const s=await I(r,"image/png");return t.setImage(s).setMimeType("image/png")}function D(t){const n=t.getIndices(),o=t.getAttribute("POSITION");switch(t.getMode()){case e.Mode.POINTS:return o.getCount();case e.Mode.LINES:return n?n.getCount()/2:o.getCount()/2;case e.Mode.LINE_LOOP:return o.getCount();case e.Mode.LINE_STRIP:return o.getCount()-1;case e.Mode.TRIANGLES:return n?n.getCount()/3:o.getCount()/3;case e.Mode.TRIANGLE_STRIP:case e.Mode.TRIANGLE_FAN:return o.getCount()-2;default:throw new Error("Unexpected mode: "+t.getMode())}}class H{constructor(){this._map=new Map}get size(){return this._map.size}has(e){return this._map.has(e)}add(e,t){let n=this._map.get(e);return n||(n=new Set,this._map.set(e,n)),n.add(t),this}get(e){return this._map.get(e)||new Set}keys(){return this._map.keys()}}function j(e,t=2){if(0===e)return"0 Bytes";const n=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,o)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][o]}function V(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function X(e,t){return`${V(e)} → ${V(t)} (${function(e,t,n=2){return(e>t?"–":"+")+(Math.abs(e-t)/e*100).toFixed(n)+"%"}(e,t)})`}function K(e){const t=[];for(const n of e.listAttributes())t.push(n);for(const n of e.listTargets())for(const e of n.listAttributes())t.push(e);return Array.from(new Set(t))}function J(e,t,n){e.swap(t,n);for(const o of e.listTargets())o.swap(t,n)}function Z(e,t,n){const o=e.getElementSize(),r=e.getCount(),s=e.getArray(),i=s.slice(0,n*o);for(let e=0;e<r;e++)for(let n=0;n<o;n++)i[t[e]*o+n]=s[e*o+n];e.setArray(i)}function Q(e,t=e){const n=t<=65534?new Uint16Array(e):new Uint32Array(e);for(let e=0;e<n.length;e++)n[e]=e;return n}function Y(e){const t=n.fromGraph(e.getGraph()),o=e.getMaterial();return`${t.getRoot().listMaterials().indexOf(o)}|${e.getMode()}|${!!e.getIndices()}|${e.listSemantics().sort().map(t=>{const n=e.getAttribute(t);return`${t}:${n.getElementSize()}:${n.getComponentType()}`}).join("+")}|${e.listTargets().map(t=>t.listSemantics().sort().map(t=>{const n=e.getAttribute(t);return`${t}:${n.getElementSize()}:${n.getComponentType()}`}).join("+")).join("~")}`}const ee="center",te={pivot:"center"};function ne(e=te){const t=q({},te,e);return B(ee,e=>{const n=e.getLogger(),r=e.getRoot(),s=r.listAnimations().length>0||r.listSkins().length>0;e.getRoot().listScenes().forEach((i,a)=>{let c;if(n.debug(`${ee}: Scene ${a+1} / ${r.listScenes().length}.`),"string"==typeof t.pivot){const e=o(i);c=[(e.max[0]-e.min[0])/2+e.min[0],(e.max[1]-e.min[1])/2+e.min[1],(e.max[2]-e.min[2])/2+e.min[2]],"above"===t.pivot&&(c[1]=e.max[1]),"below"===t.pivot&&(c[1]=e.min[1])}else c=t.pivot;n.debug(`${ee}: Pivot "${c.join(", ")}".`);const l=[-1*c[0],-1*c[1],-1*c[2]];if(s){n.debug(`${ee}: Model contains animation or skin. Adding a wrapper node.`);const t=e.createNode("Pivot").setTranslation(l);i.listChildren().forEach(e=>t.addChild(e)),i.addChild(t)}else n.debug(`${ee}: Skipping wrapper, offsetting all root nodes.`),i.listChildren().forEach(e=>{const t=e.getTranslation();e.setTranslation([t[0]+l[0],t[1]+l[1],t[2]+l[2]])})}),n.debug(`${ee}: Complete.`)})}function oe(e){const t=new Set;let n,o=e;for(;n=o.getParentNode();){if(t.has(n))throw new Error("Circular dependency in scene graph.");t.add(n),o=n}return o.listParents().filter(e=>e instanceof r)}function re(e){const t=oe(e),n=e.getParentNode();if(!n)return e;e.setMatrix(e.getWorldMatrix()),n.removeChild(e);for(const n of t)n.addChild(e);return e}var se="undefined"!=typeof Float32Array?Float32Array:Array;function ie(e,t){var n=t[0],o=t[1],r=t[2],s=t[3],i=t[4],a=t[5],c=t[6],l=t[7],g=t[8],u=t[9],f=t[10],p=t[11],m=t[12],d=t[13],h=t[14],A=t[15],T=n*a-o*i,y=n*c-r*i,E=n*l-s*i,S=o*c-r*a,M=o*l-s*a,I=r*l-s*c,w=g*d-u*m,b=g*h-f*m,N=g*A-p*m,R=u*h-f*d,C=u*A-p*d,O=f*A-p*h,$=T*O-y*C+E*R+S*N-M*b+I*w;return $?(e[0]=(a*O-c*C+l*R)*($=1/$),e[1]=(r*C-o*O-s*R)*$,e[2]=(d*I-h*M+A*S)*$,e[3]=(f*M-u*I-p*S)*$,e[4]=(c*N-i*O-l*b)*$,e[5]=(n*O-r*N+s*b)*$,e[6]=(h*E-m*I-A*y)*$,e[7]=(g*I-f*E+p*y)*$,e[8]=(i*C-a*N+l*w)*$,e[9]=(o*N-n*C-s*w)*$,e[10]=(m*M-d*E+A*T)*$,e[11]=(u*E-g*M-p*T)*$,e[12]=(a*b-i*R-c*w)*$,e[13]=(n*R-o*b+r*w)*$,e[14]=(d*y-m*S-h*T)*$,e[15]=(g*S-u*y+f*T)*$,e):null}function ae(e,t,n){var o=t[0],r=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=t[6],g=t[7],u=t[8],f=t[9],p=t[10],m=t[11],d=t[12],h=t[13],A=t[14],T=t[15],y=n[0],E=n[1],S=n[2],M=n[3];return e[0]=y*o+E*a+S*u+M*d,e[1]=y*r+E*c+S*f+M*h,e[2]=y*s+E*l+S*p+M*A,e[3]=y*i+E*g+S*m+M*T,e[4]=(y=n[4])*o+(E=n[5])*a+(S=n[6])*u+(M=n[7])*d,e[5]=y*r+E*c+S*f+M*h,e[6]=y*s+E*l+S*p+M*A,e[7]=y*i+E*g+S*m+M*T,e[8]=(y=n[8])*o+(E=n[9])*a+(S=n[10])*u+(M=n[11])*d,e[9]=y*r+E*c+S*f+M*h,e[10]=y*s+E*l+S*p+M*A,e[11]=y*i+E*g+S*m+M*T,e[12]=(y=n[12])*o+(E=n[13])*a+(S=n[14])*u+(M=n[15])*d,e[13]=y*r+E*c+S*f+M*h,e[14]=y*s+E*l+S*p+M*A,e[15]=y*i+E*g+S*m+M*T,e}function ce(){var e=new se(3);return se!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function le(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e}function ge(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e}function ue(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function fe(e,t){var n=t[0],o=t[1],r=t[2],s=n*n+o*o+r*r;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function pe(e,t,n){var o=t[0],r=t[1],s=t[2],i=n[3]*o+n[7]*r+n[11]*s+n[15];return e[0]=(n[0]*o+n[4]*r+n[8]*s+n[12])/(i=i||1),e[1]=(n[1]*o+n[5]*r+n[9]*s+n[13])/i,e[2]=(n[2]*o+n[6]*r+n[10]*s+n[14])/i,e}function me(e,t,n){var o=t[0],r=t[1],s=t[2];return e[0]=o*n[0]+r*n[3]+s*n[6],e[1]=o*n[1]+r*n[4]+s*n[7],e[2]=o*n[2]+r*n[5]+s*n[8],e}function de(){var e=new se(4);return se!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function he(e,t,n=new Set){var o;const r=e.getAttribute("POSITION"),s=(null==(o=e.getIndices())?void 0:o.getArray())||Q(r.getCount());r&&Ae(t,r,s,new Set(n));const i=e.getAttribute("NORMAL");i&&Te(t,i,s,new Set(n));const a=e.getAttribute("TANGENT");a&&ye(t,a,s,new Set(n));for(const o of e.listTargets()){const e=o.getAttribute("POSITION");e&&Ae(t,e,s,new Set(n));const r=o.getAttribute("NORMAL");r&&Te(t,r,s,new Set(n));const i=o.getAttribute("TANGENT");i&&ye(t,i,s,new Set(n))}for(let e=0;e<s.length;e++)n.add(s[e])}function Ae(e,t,n,o){const r=new Float32Array(3*t.getCount()),s=t.getElementSize();for(let e=0,n=[],o=t.getCount();e<o;e++)r.set(t.getElement(e,n),e*s);const i=ce();for(let s=0;s<n.length;s++){const a=n[s];o.has(a)||(t.getElement(a,i),pe(i,i,e),r.set(i,3*a),o.add(a))}t.setArray(r).setNormalized(!1)}function Te(e,t,n,o){const r=(s=new se(9),se!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s);var s;!function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]}(r,e),function(e,t){var n=t[0],o=t[1],r=t[2],s=t[3],i=t[4],a=t[5],c=t[6],l=t[7],g=t[8],u=g*i-a*l,f=-g*s+a*c,p=l*s-i*c,m=n*u+o*f+r*p;m&&(e[0]=u*(m=1/m),e[1]=(-g*o+r*l)*m,e[2]=(a*o-r*i)*m,e[3]=f*m,e[4]=(g*n-r*c)*m,e[5]=(-a*n+r*s)*m,e[6]=p*m,e[7]=(-l*n+o*c)*m,e[8]=(i*n-o*s)*m)}(r,r),function(e,t){if(e===t){var n=t[1],o=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=o,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(r,r);const i=ce();for(let e=0;e<n.length;e++){const s=n[e];o.has(s)||(t.getElement(s,i),me(i,i,r),fe(i,i),t.setElement(s,i),o.add(s))}}function ye(e,t,n,o){const r=ce(),s=de();for(let i=0;i<n.length;i++){const a=n[i];if(o.has(a))continue;t.getElement(a,s);const[c,l,g]=s;r[0]=e[0]*c+e[4]*l+e[8]*g,r[1]=e[1]*c+e[5]*l+e[9]*g,r[2]=e[2]*c+e[6]*l+e[10]*g,fe(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],t.setElement(a,s),o.add(a)}}function Ee(n,o,r=!1,i){for(const e of n.listPrimitives())if(e.listParents().some(e=>e.propertyType===t.MESH&&e!==n)){const t=e.clone();n.swap(e,t);for(const e of t.listTargets()){const n=e.clone();t.swap(e,n)}}if(!r){const t=new Set([...n.listPrimitives(),...n.listPrimitives().flatMap(e=>e.listTargets())]),o=new Map;for(const r of n.listPrimitives())for(const n of K(r))n.listParents().some(n=>(n instanceof e||n instanceof s)&&!t.has(n))&&!o.has(n)&&o.set(n,n.clone());for(const e of t)for(const[t,n]of o)e.swap(t,n)}const a=new Map;for(const e of n.listPrimitives()){const t=e.getAttribute("POSITION");let n;i?n=i:a.has(t)?n=a.get(t):a.set(t,n=new Set),he(e,o,n)}}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),ce(),de();const Se=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function Me(e){const t=e.getMesh(),n=e.getMatrix();t&&!i.eq(n,Se)&&Ee(t,n);for(const t of e.listChildren()){const e=t.getMatrix();ae(e,e,n),t.setMatrix(e)}return e.setMatrix(Se)}const Ie="dedup",we={propertyTypes:[t.ACCESSOR,t.MESH,t.TEXTURE,t.MATERIAL,t.SKIN]};function be(e=we){const n=q({},we,e),o=new Set(n.propertyTypes);for(const e of n.propertyTypes)if(!we.propertyTypes.includes(e))throw new Error(`${Ie}: Unsupported deduplication on type "${e}".`);return B(Ie,e=>{const n=e.getLogger();o.has(t.ACCESSOR)&&function(e){const t=e.getLogger(),n=new Map,o=new Map,r=new Map,s=new Map,i=e.getRoot().listMeshes();i.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(e=>c(e,o)),c(e.getIndices(),n)})});for(const t of e.getRoot().listAnimations())for(const e of t.listSamplers())c(e.getInput(),r),c(e.getOutput(),s);function c(e,t){if(!e)return;const n=[e.getCount(),e.getType(),e.getComponentType(),e.getNormalized(),e.getSparse()].join(":");let o=t.get(n);o||t.set(n,o=new Set),o.add(e)}function l(e,t){for(let n=0;n<e.length;n++){const o=e[n],r=a.toView(o.getArray());if(!t.has(o))for(let s=n+1;s<e.length;s++){const n=e[s];t.has(n)||a.equals(r,a.toView(n.getArray()))&&t.set(n,o)}}}let g=0;const u=new Map;for(const e of[o,n,r,s])for(const t of e.values())g+=t.size,l(Array.from(t),u);t.debug(`${Ie}: Merged ${u.size} of ${g} accessors.`),i.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(t=>{u.has(t)&&e.swap(t,u.get(t))});const t=e.getIndices();t&&u.has(t)&&e.swap(t,u.get(t))})});for(const t of e.getRoot().listAnimations())for(const e of t.listSamplers()){const t=e.getInput(),n=e.getOutput();t&&u.has(t)&&e.swap(t,u.get(t)),n&&u.has(n)&&e.swap(n,u.get(n))}Array.from(u.keys()).forEach(e=>e.dispose())}(e),o.has(t.TEXTURE)&&function(e){const t=e.getLogger(),n=e.getRoot(),o=n.listTextures(),r=new Map;for(let e=0;e<o.length;e++){const t=o[e],n=t.getImage();if(!r.has(t))for(let s=e+1;s<o.length;s++){const e=o[s],i=e.getImage();if(r.has(e))continue;if(t.getMimeType()!==e.getMimeType())continue;const c=t.getSize(),l=e.getSize();c&&l&&c[0]===l[0]&&c[1]===l[1]&&n&&i&&a.equals(n,i)&&r.set(e,t)}}t.debug(`${Ie}: Merged ${r.size} of ${n.listTextures().length} textures.`),Array.from(r.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof c||n.swap(e,t)}),e.dispose()})}(e),o.has(t.MATERIAL)&&function(e){const t=e.getLogger(),n=e.getRoot().listMaterials(),o=new Map,r=new Set(["name"]),s=new Map;for(let e=0;e<n.length;e++){const t=n[e];if(!o.has(t)&&!Re(t,s))for(let i=e+1;i<n.length;i++){const e=n[i];o.has(e)||Re(e,s)||t.equals(e,r)&&o.set(e,t)}}t.debug(`${Ie}: Merged ${o.size} of ${n.length} materials.`),Array.from(o.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof c||n.swap(e,t)}),e.dispose()})}(e),o.has(t.MESH)&&function(e){const n=e.getLogger(),o=e.getRoot(),r=new Map;o.listAccessors().forEach((e,t)=>r.set(e,t)),o.listMaterials().forEach((e,t)=>r.set(e,t));const s=o.listMeshes().length,i=new Map;for(const e of o.listMeshes()){const n=[];for(const t of e.listPrimitives())n.push(Ne(t,r));const o=n.join(";");if(i.has(o)){const n=i.get(o);e.listParents().forEach(o=>{o.propertyType!==t.ROOT&&o.swap(e,n)}),e.dispose()}else i.set(o,e)}n.debug(`${Ie}: Merged ${s-i.size} of ${s} meshes.`)}(e),o.has(t.SKIN)&&function(e){const t=e.getLogger(),n=e.getRoot().listSkins(),o=new Map,r=new Set(["name"]);for(let e=0;e<n.length;e++){const t=n[e];if(!o.has(t))for(let s=e+1;s<n.length;s++){const e=n[s];o.has(e)||t.equals(e,r)&&o.set(e,t)}}t.debug(`${Ie}: Merged ${o.size} of ${n.length} skins.`),Array.from(o.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof c||n.swap(e,t)}),e.dispose()})}(e),n.debug(`${Ie}: Complete.`)})}function Ne(t,n){const o=[];for(const e of t.listSemantics()){const r=t.getAttribute(e);o.push(e+":"+n.get(r))}if(t instanceof e){const e=t.getIndices();e&&o.push("indices:"+n.get(e));const r=t.getMaterial();r&&o.push("material:"+n.get(r)),o.push("mode:"+t.getMode());for(const e of t.listTargets())o.push("target:"+Ne(e,n))}return o.join(",")}function Re(e,t){if(t.has(e))return t.get(e);const n=e.getGraph(),o=new Set,r=n.listParentEdges(e);for(;r.length>0;){const s=r.pop();if(!0===s.getAttributes().modifyChild)return t.set(e,!0),!0;const i=s.getChild();if(!o.has(i))for(const e of n.listChildEdges(i))r.push(e)}return t.set(e,!1),!1}const Ce="dequantize",Oe={pattern:/^((?!JOINTS_).)*$/};function $e(e=Oe){const t=q({},Oe,e);return B(Ce,e=>{const n=e.getLogger();for(const n of e.getRoot().listMeshes())for(const e of n.listPrimitives())ve(e,t);e.createExtension(w).dispose(),n.debug(`${Ce}: Complete.`)})}function ve(e,t){for(const n of e.listSemantics())Pe(n,e.getAttribute(n),t);for(const n of e.listTargets())for(const e of n.listSemantics())Pe(e,n.getAttribute(e),t)}function Pe(e,t,n){if(!t.getArray())return;if(!n.pattern.test(e))return;if(t.getComponentSize()>=4)return;const o=t.getArray(),r=new Float32Array(o.length);for(let e=0,n=t.getCount(),s=[];e<n;e++)s=t.getElement(e,s),t.setArray(r).setElement(e,s).setArray(o);t.setArray(r).setNormalized(!1)}function xe(e){const t=e.getGraph(),n=new Set;for(const o of t.listParentEdges(e)){const e=o.getParent(),r=o.getName()+"Info";for(const o of t.listChildEdges(e)){const e=o.getChild();e instanceof l&&o.getName()===r&&n.add(e)}}return Array.from(n)}function Le(e){const t=e.getGraph(),n=new Set,o=new Set;return function e(r){const s=new Set;for(const e of t.listChildEdges(r))e.getChild()instanceof g&&s.add(e.getName()+"Info");for(const i of t.listChildEdges(r)){const t=i.getChild();n.has(t)||(n.add(t),t instanceof l&&s.has(i.getName())?o.add(t):t instanceof u&&e(t))}}(e),Array.from(o)}const ze="prune",Fe={propertyTypes:[t.NODE,t.SKIN,t.MESH,t.CAMERA,t.PRIMITIVE,t.PRIMITIVE_TARGET,t.ANIMATION,t.MATERIAL,t.TEXTURE,t.ACCESSOR,t.BUFFER],keepLeaves:!1,keepAttributes:!0};function _e(e=Fe){const n=q({},Fe,e),o=new Set(n.propertyTypes);return B(ze,e=>{const s=e.getLogger(),i=e.getRoot(),a=e.getGraph(),l={};if(o.has(t.MESH))for(const e of i.listMeshes())e.listPrimitives().length>0||(e.dispose(),m(e));if(o.has(t.NODE)&&!n.keepLeaves&&i.listScenes().forEach(function e(n){if(n.listChildren().forEach(e),n instanceof r)return;const o=a.listParentEdges(n).some(e=>{const n=e.getParent().propertyType;return n!==t.ROOT&&n!==t.SCENE&&n!==t.NODE});0!==a.listChildren(n).length||o||(n.dispose(),m(n))}),o.has(t.NODE)&&i.listNodes().forEach(g),o.has(t.SKIN)&&i.listSkins().forEach(g),o.has(t.MESH)&&i.listMeshes().forEach(g),o.has(t.CAMERA)&&i.listCameras().forEach(g),o.has(t.PRIMITIVE)&&u(a,t.PRIMITIVE),o.has(t.PRIMITIVE_TARGET)&&u(a,t.PRIMITIVE_TARGET),!n.keepAttributes&&o.has(t.ACCESSOR)){const t=new Map;for(const n of i.listMeshes())for(const o of n.listPrimitives()){const n=o.getMaterial(),r=Ge(o,ke(e,n));p(o,r),o.listTargets().forEach(e=>p(e,r)),n&&(t.has(n)?t.get(n).add(o):t.set(n,new Set([o])))}for(const[e,n]of t)qe(e,Array.from(n))}if(o.has(t.ANIMATION))for(const e of i.listAnimations()){for(const t of e.listChannels())t.getTargetNode()||(t.dispose(),m(t));if(e.listChannels().length)e.listSamplers().forEach(g);else{const t=e.listSamplers();g(e),t.forEach(g)}}if(o.has(t.MATERIAL)&&i.listMaterials().forEach(g),o.has(t.TEXTURE)&&i.listTextures().forEach(g),o.has(t.ACCESSOR)&&i.listAccessors().forEach(g),o.has(t.BUFFER)&&i.listBuffers().forEach(g),Object.keys(l).length){const e=Object.keys(l).map(e=>`${e} (${l[e]})`).join(", ");s.info(`${ze}: Removed types... ${e}`)}else s.info(`${ze}: No unused properties found.`);function g(e){e.listParents().filter(e=>!(e instanceof c||e instanceof f)).length||(e.dispose(),m(e))}function u(e,t){e.listEdges().map(e=>e.getParent()).filter(e=>e.propertyType===t).forEach(g)}function p(e,t){for(const n of t)e.setAttribute(n,null)}function m(e){l[e.propertyType]=l[e.propertyType]||0,l[e.propertyType]++}s.debug(`${ze}: Complete.`)})}function Ge(e,t){const n=[];for(const o of e.listSemantics())"TANGENT"!==o||t.has(o)?(o.startsWith("TEXCOORD_")&&!t.has(o)||o.startsWith("COLOR_")&&"COLOR_0"!==o)&&n.push(o):n.push(o);return n}function ke(e,t,n=new Set){if(!t)return n;const o=e.getGraph().listChildEdges(t),r=new Set;for(const e of o)e.getChild()instanceof g&&r.add(e.getName());for(const t of o){const o=t.getName(),s=t.getChild();s instanceof l&&r.has(o.replace(/Info$/,""))&&n.add(`TEXCOORD_${s.getTexCoord()}`),s instanceof g&&o.match(/normalTexture/i)&&n.add("TANGENT"),s instanceof u&&ke(e,s,n)}return n}function qe(e,t){const n=Le(e),o=new Set(n.map(e=>e.getTexCoord())),r=Array.from(o).sort(),s=new Map(r.map((e,t)=>[e,t])),i=new Map(r.map((e,t)=>[`TEXCOORD_${e}`,`TEXCOORD_${t}`]));for(const e of n){const t=e.getTexCoord();e.setTexCoord(s.get(t))}for(const e of t){const t=e.listSemantics().filter(e=>e.startsWith("TEXCOORD_")).sort();a(e,t),e.listTargets().forEach(e=>a(e,t))}function a(e,t){for(const n of t){const t=e.getAttribute(n);if(!t)continue;const o=i.get(n);o!==n&&(e.setAttribute(o,t),e.setAttribute(n,null))}}}const Be="weld",Ue={DEFAULT:1e-4,TEXCOORD:1e-4,COLOR:.01,NORMAL:.5,JOINTS:0,WEIGHTS:.01},We={tolerance:Ue.DEFAULT,overwrite:!0,exhaustive:!1};function De(e=We){const n=q({},We,e);if(n.tolerance>.1||n.tolerance<0)throw new Error(`${Be}: Requires 0 ≤ tolerance ≤ 0.1`);return B(Be,async e=>{const o=e.getLogger();for(const t of e.getRoot().listMeshes()){for(const o of t.listPrimitives())He(e,o,n),0===o.getIndices().getCount()&&o.dispose();0===t.listPrimitives().length&&t.dispose()}await e.transform(_e({propertyTypes:[t.ACCESSOR,t.NODE]})),await e.transform(be({propertyTypes:[t.ACCESSOR]})),o.debug(`${Be}: Complete.`)})}function He(t,n,o){n.getIndices()&&!o.overwrite||n.getMode()!==e.Mode.POINTS&&(0===o.tolerance?function(e,t){if(t.getIndices())return;const n=t.listAttributes()[0],o=n.getCount(),r=n.getBuffer(),s=e.createAccessor().setBuffer(r).setType(p.Type.SCALAR).setArray(Q(o));t.setIndices(s)}(t,n):function(e,t,n){const o=e.getLogger(),r=t.getAttribute("POSITION"),s=t.getIndices()||e.createAccessor().setArray(Q(r.getCount())),i=new Uint32Array(new Set(s.getArray())).sort(),a=Math.max(n.tolerance,Number.EPSILON),c={};for(const e of t.listSemantics()){const n=t.getAttribute(e);c[e]=Ke(e,n,a)}var l;o.debug(`${Be}: Tolerance thresholds: ${l=c,Object.entries(l).map(([e,t])=>`${e}=${t}`).join(", ")}`);const g=[0,0,0],u=[0,0,0],f={},p=c.POSITION;for(let e=0;e<i.length;e++){r.getElement(i[e],g);const t=Ye(g,p);f[t]=f[t]||[],f[t].push(i[e])}const m=Q(i[i.length-1]+1),d=new Array(i.length).fill(-1),h=r.getCount();let A=0;for(let e=0;e<i.length;e++){const o=i[e];r.getElement(o,g);const s=n.exhaustive?Qe(g,p):[Ye(g,p)];e:for(const e of s)if(f[e])t:for(const n of f[e]){const e=m[n];if(o<=e)continue t;r.getElement(e,u);const s=t.listSemantics().every(n=>Je(t.getAttribute(n),o,e,c[n])),i=t.listTargets().every(t=>t.listSemantics().every(n=>Je(t.getAttribute(n),o,e,c[n])));if(s&&i){m[o]=e;break e}}d[o]=m[o]===o?A++:d[m[o]]}o.debug(`${Be}: ${X(h,A)} vertices.`);const T=s.getCount(),y=Q(T,i.length);for(let e=0;e<T;e++)y[e]=d[s.getScalar(e)];t.setIndices(s.clone().setArray(y)),1===s.listParents().length&&s.dispose();for(const e of t.listAttributes())je(t,e,d,A);for(const e of t.listTargets())for(const t of e.listAttributes())je(e,t,d,A);!function(e){const t=e.getIndices();if(!t)return;const n=[];let o=-Infinity;for(let e=0,r=t.getCount();e<r;e+=3){const r=t.getScalar(e),s=t.getScalar(e+1),i=t.getScalar(e+2);r!==s&&r!==i&&s!==i&&(n.push(r,s,i),o=Math.max(o,r,s,i))}const r=Q(n.length,o);r.set(n),t.setArray(r)}(t)}(t,n,o))}function je(e,t,n,o){const r=(s=t.getArray(),i=o*t.getElementSize(),new(0,s.constructor)(i));var s,i;const a=t.clone().setArray(r),c=new Uint8Array(o);for(let e=0,o=[];e<n.length;e++)c[n[e]]||(a.setElement(n[e],t.getElement(e,o)),c[n[e]]=1);e.swap(t,a),1===t.listParents().length&&t.dispose()}const Ve=[],Xe=[];function Ke(e,t,n){return"NORMAL"===e||"TANGENT"===e?Ue.NORMAL:e.startsWith("COLOR_")?Ue.COLOR:e.startsWith("TEXCOORD_")?Ue.TEXCOORD:e.startsWith("JOINTS_")?Ue.JOINTS:e.startsWith("WEIGHTS_")?Ue.WEIGHTS:(Ve.length=Xe.length=0,t.getMinNormalized(Ve),t.getMaxNormalized(Xe),n*(Math.max(...Xe)-Math.min(...Ve)||1))}function Je(e,t,n,o,r){e.getElement(t,Ve),e.getElement(n,Xe);for(let t=0,n=e.getElementSize();t<n;t++)if(Math.abs(Ve[t]-Xe[t])>o)return!1;return!0}const Ze=[0,-1,1];function Qe(e,t){const n=[],o=[0,0,0];for(const r of Ze)for(const s of Ze)for(const i of Ze)o[0]=e[0]+r*t,o[1]=e[1]+s*t,o[2]=e[2]+i*t,n.push(Ye(o,t));return n}function Ye(e,t){return Math.round(e[0]/t)+":"+Math.round(e[1]/t)+":"+Math.round(e[2]/t)}const et={method:"edgebreaker",encodeSpeed:5,decodeSpeed:5,quantizePosition:14,quantizeNormal:10,quantizeColor:8,quantizeTexcoord:12,quantizeGeneric:12,quantizationVolume:"mesh"};function tt(e=et){const t=q({},et,e);return B("draco",async e=>{await e.transform(De({tolerance:0})),e.createExtension(b).setRequired(!0).setEncoderOptions({method:"edgebreaker"===t.method?b.EncoderMethod.EDGEBREAKER:b.EncoderMethod.SEQUENTIAL,encodeSpeed:t.encodeSpeed,decodeSpeed:t.decodeSpeed,quantizationBits:{POSITION:t.quantizePosition,NORMAL:t.quantizeNormal,COLOR:t.quantizeColor,TEX_COORD:t.quantizeTexcoord,GENERIC:t.quantizeGeneric},quantizationVolume:t.quantizationVolume})})}const nt="flatten",ot={};function rt(e=ot){return q({},ot,e),B(nt,async e=>{const n=e.getRoot(),o=e.getLogger(),r=new Set;for(const e of n.listSkins())for(const t of e.listJoints())r.add(t);const s=new Set;for(const e of n.listAnimations())for(const t of e.listChannels()){const e=t.getTargetNode();e&&s.add(e)}const i=new Set,a=new Set;for(const e of n.listScenes())e.traverse(e=>{const t=e.getParentNode();t&&((r.has(t)||i.has(t))&&i.add(e),(s.has(t)||a.has(t))&&a.add(e))});for(const e of n.listScenes())e.traverse(e=>{s.has(e)||i.has(e)||a.has(e)||re(e)});s.size&&o.debug(`${nt}: Flattening node hierarchies with TRS animation not yet supported.`),await e.transform(_e({propertyTypes:[t.NODE],keepLeaves:!1})),o.debug(`${nt}: Complete.`)})}function st(e){return oe(e)[0]||null}const it=/color|emissive|diffuse/i;function at(e){return e.getGraph().listParentEdges(e).some(e=>e.getAttributes().isColor||it.test(e.getName()))?"srgb":null}function ct(e){return{scenes:lt(e),meshes:gt(e),materials:ut(e),textures:ft(e),animations:pt(e)}}function lt(e){return{properties:e.getRoot().listScenes().map(e=>{const t=e.listChildren()[0],n=o(e);return{name:e.getName(),rootName:t?t.getName():"",bboxMin:ht(n.min),bboxMax:ht(n.max)}})}}function gt(e){return{properties:e.getRoot().listMeshes().map(e=>{const n=e.listParents().filter(e=>e.propertyType!==t.ROOT).length;let o=0,r=0;const s=new Set,i=new Set,a=new Set;e.listPrimitives().forEach(e=>{for(const t of e.listSemantics()){const n=e.getAttribute(t);s.add(t+":"+At(n)),a.add(n)}for(const t of e.listTargets())t.listAttributes().forEach(e=>a.add(e));const t=e.getIndices();t&&(i.add(At(t)),a.add(t)),r+=e.listAttributes()[0].getCount(),o+=D(e)});let c=0;Array.from(a).forEach(e=>c+=e.getArray().byteLength);const l=e.listPrimitives().map(e=>mt[e.getMode()]);return{name:e.getName(),mode:Array.from(new Set(l)),primitives:e.listPrimitives().length,glPrimitives:o,vertices:r,indices:Array.from(i).sort(),attributes:Array.from(s).sort(),instances:n,size:c}})}}function ut(e){return{properties:e.getRoot().listMaterials().map(n=>{const o=n.listParents().filter(e=>e.propertyType!==t.ROOT).length,r=new Set(n.listExtensions()),s=e.getGraph().listEdges().filter(e=>{const t=e.getChild(),o=e.getParent();return t instanceof g&&o===n||!!(t instanceof g&&o instanceof u&&r.has(o))}).map(e=>e.getName());return{name:n.getName(),instances:o,textures:s,alphaMode:n.getAlphaMode(),doubleSided:n.getDoubleSided()}})}}function ft(e){return{properties:e.getRoot().listTextures().map(n=>{const o=n.listParents().filter(e=>e.propertyType!==t.ROOT).length,r=e.getGraph().listParentEdges(n).filter(e=>e.getParent().propertyType!==t.ROOT).map(e=>e.getName()),s=m.getSize(n.getImage(),n.getMimeType());let i="";if("image/ktx2"===n.getMimeType()){const e=L(n.getImage()).dataFormatDescriptor[0];e.colorModel===z?i="ETC1S":e.colorModel===F&&(i="UASTC")}return{name:n.getName(),uri:n.getURI(),slots:Array.from(new Set(r)),instances:o,mimeType:n.getMimeType(),compression:i,resolution:s?s.join("x"):"",size:n.getImage().byteLength,gpuSize:m.getVRAMByteLength(n.getImage(),n.getMimeType())}})}}function pt(e){return{properties:e.getRoot().listAnimations().map(e=>{let t=Infinity,n=-Infinity;e.listSamplers().forEach(e=>{const o=e.getInput();o&&(t=Math.min(t,o.getMin([])[0]),n=Math.max(n,o.getMax([])[0]))});let o=0,r=0;const s=new Set;return e.listSamplers().forEach(e=>{const t=e.getInput(),n=e.getOutput();t&&(r+=t.getCount(),s.add(t),n&&s.add(n))}),Array.from(s).forEach(e=>{o+=e.getArray().byteLength}),{name:e.getName(),channels:e.listChannels().length,samplers:e.listSamplers().length,duration:Math.round(1e3*(n-t))/1e3,keyframes:r,size:o}})}}const mt=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"],dt={Float32Array:"f32",Uint32Array:"u32",Uint16Array:"u16",Uint8Array:"u8",Int32Array:"i32",Int16Array:"i16",Int8Array:"i8"};function ht(e){for(let t=0;t<e.length;t++)e[t].toFixed&&(e[t]=Number(e[t].toFixed(5)));return e}function At(e){const t=e.getArray();return(dt[t.constructor.name]||"?")+(e.getNormalized()?"_norm":"")}const Tt="instance",yt={min:2};function Et(e=yt){const t=q({},yt,e);return B(Tt,e=>{const n=e.getLogger(),o=e.getRoot();if(o.listAnimations().length)return n.warn(`${Tt}: Instancing is not currently supported for animated models.`),void n.debug(`${Tt}: Complete.`);const r=e.createExtension(N);let s=0,a=0;for(const c of o.listScenes()){const o=new Map;c.traverse(e=>{const t=e.getMesh();t&&o.set(t,(o.get(t)||new Set).add(e))});const l=[];for(const g of Array.from(o.keys())){const u=Array.from(o.get(g));if(u.length<t.min)continue;if(u.some(e=>e.getSkin()))continue;const f=Mt(e,r,g,u.length),p=f.getAttribute("TRANSLATION"),m=f.getAttribute("ROTATION"),d=f.getAttribute("SCALE"),h=e.createNode().setMesh(g).setExtension("EXT_mesh_gpu_instancing",f);c.addChild(h);let A=!1,T=!1,y=!1;for(let e=0;e<u.length;e++){let t,n,o;const r=u[e];p.setElement(e,t=r.getWorldTranslation()),m.setElement(e,n=r.getWorldRotation()),d.setElement(e,o=r.getWorldScale()),i.eq(t,[0,0,0])||(A=!0),i.eq(n,[0,0,0,1])||(T=!0),i.eq(o,[1,1,1])||(y=!0),r.setMesh(null),l.push(r)}A||p.dispose(),T||m.dispose(),y||d.dispose(),St(l,n),s++,a+=u.length}}n.info(s>0?`${Tt}: Created ${s} batches, with ${a} total instances.`:`${Tt}: No meshes with ≥${t.min} parent nodes were found.`),0===r.listProperties().length&&r.dispose(),n.debug(`${Tt}: Complete.`)})}function St(e,t){let n,o=0;for(;n=e.pop();){if(n.listChildren().length||n.getCamera()||n.getMesh()||n.getSkin()||n.listExtensions().length)continue;const t=n.getParentNode();t&&e.push(t),n.dispose(),o++}t.debug(`${Tt}: Removed ${o} unused nodes.`)}function Mt(e,t,n,o){const r=n.listPrimitives()[0].getAttribute("POSITION").getBuffer(),s=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*o)).setBuffer(r),i=e.createAccessor().setType("VEC4").setArray(new Float32Array(4*o)).setBuffer(r),a=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*o)).setBuffer(r);return t.createInstancedMesh().setAttribute("TRANSLATION",s).setAttribute("ROTATION",i).setAttribute("SCALE",a)}const It={skipValidation:!1};function wt(e,t={}){t=q({},It,t);const o=e[0],r=n.fromGraph(o.getGraph());if(!t.skipValidation&&new Set(e.map(Y)).size>1)throw new Error("Requires ≥2 Primitives, sharing the same Material and Mode, with compatible vertex attributes and indices.");const s=[],i=[];let a=0,c=0;for(const t of e){const e=bt(t),n=[];for(let t=0;t<e.length;t++){const o=e[t];void 0===n[o]&&(n[o]=a++),c++}s.push(new Uint32Array(n)),i.push(e)}const l=r.createPrimitive().setMode(o.getMode()).setMaterial(o.getMaterial());for(const e of o.listSemantics()){const t=o.getAttribute(e),n=d[t.getComponentType()],s=r.createAccessor().setType(t.getType()).setBuffer(t.getBuffer()).setNormalized(t.getNormalized()).setArray(new n(a*t.getElementSize()));l.setAttribute(e,s)}const g=(o.getIndices()?Q(a):null)&&r.createAccessor().setBuffer(o.getIndices().getBuffer()).setArray(Q(c,a));l.setIndices(g);let u=0;for(let t=0;t<s.length;t++){const n=e[t],o=s[t],r=i[t],a=u;let c=a;for(const e of l.listSemantics()){const t=n.getAttribute(e),s=l.getAttribute(e),i=[];c=a;for(let e=0;e<r.length;e++){const n=r[e];t.getElement(n,i),s.setElement(o[n],i),g&&g.setScalar(c++,o[n])}}u=c}return l}function bt(e){const t=e.getIndices();return t?t.getArray():Q(e.getAttribute("POSITION").getCount())}const Nt="join",{ROOT:Rt,NODE:Ct,MESH:Ot,PRIMITIVE:$t,ACCESSOR:vt}=t,Pt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],xt={keepMeshes:!1,keepNamed:!1};function Lt(e=xt){const t=q({},xt,e);return B(Nt,async e=>{const n=e.getRoot(),o=e.getLogger();for(const o of n.listScenes())zt(e,o,t),o.traverse(n=>zt(e,n,t));await e.transform(_e({propertyTypes:[Ct,Ot,$t,vt],keepLeaves:!1,keepAttributes:!0})),o.debug(`${Nt}: Complete.`)})}function zt(e,n,o){const r=e.getLogger(),s={},i=n.listChildren();for(let e=0;e<i.length;e++){const t=i[e];if(t.listParents().some(e=>e instanceof f))continue;const n=t.getMesh();if(n&&!t.getExtension("EXT_mesh_gpu_instancing")&&!t.getSkin())for(const r of n.listPrimitives()){if(r.listTargets().length>0)continue;const i=r.getMaterial();if(i&&i.getExtension("KHR_materials_volume"))continue;let a=Y(r);const c=n.getName()||t.getName();(o.keepMeshes||o.keepNamed&&c)&&(a+=`|${e}`),a in s||(s[a]={prims:[],primMeshes:[],primNodes:[],dstNode:t,dstMesh:void 0});const l=s[a];l.prims.push(r),l.primNodes.push(t)}}const a=Object.values(s).filter(({prims:e})=>e.length>1),c=new Set(a.flatMap(e=>e.primNodes));for(const e of c){const t=e.getMesh(),n=t.listParents().some(t=>t.propertyType!==Rt&&e!==t);n&&e.setMesh(t.clone())}for(const e of a){const{dstNode:t,primNodes:n}=e;e.dstMesh=t.getMesh(),e.primMeshes=n.map(e=>e.getMesh())}for(const e of a){const{prims:n,primNodes:o,primMeshes:s,dstNode:i,dstMesh:a}=e,c=i.getMatrix();for(let e=0;e<n.length;e++){const r=o[e];let a=n[e];s[e].removePrimitive(a),(a.listParents().some(e=>e.propertyType!==t.ROOT)||_t(a))&&(a=n[e]=Ft(n[e])),r!==i&&(ae(Pt,ie(Pt,c),r.getMatrix()),he(a,Pt))}const l=wt(n),g=l.listAttributes()[0].getCount();a.addPrimitive(l),r.debug(`${Nt}: Joined Primitives (${n.length}) containing ${V(g)} vertices under Node "${i.getName()}".`)}}function Ft(e){const t=e.clone();for(const e of t.listSemantics())t.setAttribute(e,t.getAttribute(e).clone());const n=t.getIndices();return n&&t.setIndices(n.clone()),t}function _t(e){for(const t of e.listAttributes())for(const n of t.listParents())if(n!==e&&n.propertyType!==Rt)return!0;return!1}function Gt(e){const t=kt(e),n=[];return t&h.R&&n.push(h.R),t&h.G&&n.push(h.G),t&h.B&&n.push(h.B),t&h.A&&n.push(h.A),n}function kt(e){const o=n.fromGraph(e.getGraph());let r=0;for(const n of o.getGraph().listParentEdges(e)){const e=n.getParent();let{channels:s}=n.getAttributes();s&&"baseColorTexture"===n.getName()&&e instanceof A&&e.getAlphaMode()===A.AlphaMode.OPAQUE&&(s&=~h.A),s?r|=s:e.propertyType!==t.ROOT&&o.getLogger().warn(`Missing attribute ".channels" on edge, "${n.getName()}".`)}return r}function qt(e){const t=n.fromGraph(e.getGraph()).getRoot(),o=e.getGraph().listParentEdges(e).filter(e=>e.getParent()!==t).map(e=>e.getName());return Array.from(new Set(o))}const Bt="reorder",Ut={target:"size"};function Wt(n){const o=q({},Ut,n),r=o.encoder;if(!r)throw new Error(`${Bt}: encoder dependency required — install "meshoptimizer".`);return B(Bt,async n=>{const s=n.getLogger();await r.ready;const i=function(e){const t=new H,n=new Map,o=new H;for(const r of e.getRoot().listMeshes())for(const e of r.listPrimitives()){const r=e.getIndices();if(r){n.set(r,e.getMode());for(const n of K(e))t.add(r,n),o.add(n,e)}}return{indicesToAttributes:t,indicesToMode:n,attributesToPrimitives:o}}(n);for(const t of i.indicesToAttributes.keys()){const n=t.clone();let s=n.getArray().slice();s instanceof Uint32Array||(s=new Uint32Array(s));const[a,c]=r.reorderMesh(s,i.indicesToMode.get(t)===e.Mode.TRIANGLES,"size"===o.target);n.setArray(c<=65534?new Uint16Array(s):s);for(const e of i.indicesToAttributes.get(t)){const o=e.clone();Z(o,a,c);for(const r of i.attributesToPrimitives.get(e))if(r.getIndices()===t&&r.swap(t,n),r.getIndices()===n){r.swap(e,o);for(const t of r.listTargets())t.swap(e,o)}}}await n.transform(_e({propertyTypes:[t.ACCESSOR]})),i.indicesToAttributes.size?s.debug(`${Bt}: Complete.`):s.warn(`${Bt}: No qualifying primitives found; may need to weld first.`)})}function Dt(e,t=Infinity){if(Number.isFinite(t)&&t%4||t<=0)throw new Error("Limit must be positive multiple of four.");const n=e.getAttribute("POSITION").getCount(),o=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,r=new Uint16Array(4*o),s=new Float32Array(4*o),a=new Float32Array(4*o),c=new Uint32Array(4*o),l=new Uint32Array(4*o);for(let t=0;t<n;t++){Ht(e,t,"WEIGHTS",s),Ht(e,t,"JOINTS",c);for(let e=0;e<4*o;e++)r[e]=e;r.sort((e,t)=>s[e]>s[t]?-1:1);for(let e=0;e<r.length;e++)a[e]=s[r[e]],l[e]=c[r[e]];jt(e,t,"WEIGHTS",a),jt(e,t,"JOINTS",l)}for(let n=o;4*n>t;n--){const t=e.getAttribute("WEIGHTS_"+(n-1)),o=e.getAttribute("JOINTS_"+(n-1));e.setAttribute("WEIGHTS_"+(n-1),null),e.setAttribute("JOINTS_"+(n-1),null),1===t.listParents().length&&t.dispose(),1===o.listParents().length&&o.dispose()}!function(e){if(!function(e){const t=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).map(t=>e.getAttribute(t)),n=t.map(e=>e.getNormalized()),o=t.map(e=>e.getComponentType());return 1===new Set(n).size&&1===new Set(o).size}(e))return;const t=e.getAttribute("POSITION").getCount(),n=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,o=e.getAttribute("WEIGHTS_0"),r=o.getArray(),s=o.getComponentType(),a=o.getNormalized(),c=a?s:void 0,l=a?i.decodeNormalizedInt(1,s):Number.EPSILON,g=new Uint32Array(4*n).fill(0),u=r.slice(0,4*n).fill(0);for(let n=0;n<t;n++){Ht(e,n,"JOINTS",g),Ht(e,n,"WEIGHTS",u,c);let t=Vt(u,c);if(0!==t){if(Math.abs(1-t)>l)for(let e=0;e<u.length;e++)if(a){const n=i.encodeNormalizedInt(u[e]/t,s);u[e]=i.decodeNormalizedInt(n,s)}else u[e]/=t;if(t=Vt(u,c),a&&1!==t)for(let e=u.length-1;e>=0;e--)if(u[e]>0){u[e]+=i.encodeNormalizedInt(1-t,s);break}for(let e=u.length-1;e>=0;e--)0===u[e]&&(g[e]=0);jt(e,n,"JOINTS",g),jt(e,n,"WEIGHTS",u,c)}}}(e)}function Ht(e,t,n,o,r){let s;const a=[0,0,0,0];for(let c=0;s=e.getAttribute(`${n}_${c}`);c++){s.getElement(t,a);for(let e=0;e<4;e++)o[4*c+e]=r?i.encodeNormalizedInt(a[e],r):a[e]}return o}function jt(e,t,n,o,r){let s;const a=[0,0,0,0];for(let c=0;s=e.getAttribute(`${n}_${c}`);c++){for(let e=0;e<4;e++)a[e]=r?i.decodeNormalizedInt(o[4*c+e],r):o[4*c+e];s.setElement(t,a)}}function Vt(e,t){let n=0;for(let o=0;o<e.length;o++)n+=t?i.decodeNormalizedInt(e[o],t):e[o];return n}const Xt="quantize",Kt=[Int8Array,Int16Array,Int32Array],{TRANSLATION:Jt,ROTATION:Zt,SCALE:Qt,WEIGHTS:Yt}=f.TargetPath,en=[Jt,Zt,Qt],tn={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0};function nn(e=tn){const n=q({},tn,e);return B(Xt,async e=>{const o=e.getLogger(),r=e.getRoot();let s;e.createExtension(w).setRequired(!0),"scene"===n.quantizationVolume&&(s=rn(function(e){const t=e[0];for(const n of e)le(t.min,t.min,n.min),ge(t.max,t.max,n.max);return t}(r.listMeshes().map(fn))));for(const t of e.getRoot().listMeshes()){"mesh"===n.quantizationVolume&&(s=rn(fn(t))),s&&n.pattern.test("POSITION")&&(sn(e,t,s),ln(t,1/s.scale));for(const o of t.listPrimitives()){on(e,o,s,n);for(const t of o.listTargets())on(e,t,s,n)}}await e.transform(_e({propertyTypes:[t.ACCESSOR,t.SKIN,t.MATERIAL]}),be({propertyTypes:[t.ACCESSOR,t.MATERIAL,t.SKIN]})),o.debug(`${Xt}: Complete.`)})}function on(t,n,o,r){const s=t.getLogger();for(const t of n.listSemantics()){if(!r.pattern.test(t))continue;const c=n.getAttribute(t),{bits:l,ctor:g}=un(t,c,s,r);if(!g)continue;if(l<8||l>16)throw new Error(`${Xt}: Requires bits = 8–16.`);if(c.getComponentSize()<=l/8)continue;const u=c.clone();if("POSITION"===t){const t=o.scale,r=[];n instanceof e?ie(r,mn(o)):((i=r)[0]=(a=[1/t,1/t,1/t])[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=a[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1);for(let e=0,t=[0,0,0],n=u.getCount();e<n;e++)u.getElement(e,t),u.setElement(e,pe(t,t,r))}gn(u,g,l),n.swap(c,u)}var i,a;if(r.normalizeWeights&&n.getAttribute("WEIGHTS_0")&&Dt(n,Infinity),n instanceof e&&n.getIndices()&&n.listAttributes().length&&n.listAttributes()[0].getCount()<65535){const e=n.getIndices();e.setArray(new Uint16Array(e.getArray()))}}function rn(e){const{min:t,max:n}=e,o=Math.max((n[0]-t[0])/2,(n[1]-t[1])/2,(n[2]-t[2])/2);return{offset:[t[0]+(n[0]-t[0])/2,t[1]+(n[1]-t[1])/2,t[2]+(n[2]-t[2])/2],scale:o}}function sn(e,t,n){const o=mn(n);for(const r of t.listParents()){if(!(r instanceof T))continue;const s=r.listParents().filter(e=>e instanceof f),i=s.some(e=>en.includes(e.getTargetPath())),a=r.listChildren().length>0,c=r.getSkin();if(c){r.setSkin(an(c,n));continue}const l=r.getExtension("EXT_mesh_gpu_instancing");if(l){r.setExtension("EXT_mesh_gpu_instancing",cn(l,n));continue}let g;a||i?(g=e.createNode("").setMesh(t),r.addChild(g).setMesh(null),s.filter(e=>e.getTargetPath()===Yt).forEach(e=>e.setTargetNode(g))):g=r;const u=g.getMatrix();ae(u,u,o),g.setMatrix(u)}}function an(e,t){e=e.clone();const n=mn(t),o=e.getInverseBindMatrices().clone(),r=[];for(let e=0,t=o.getCount();e<t;e++)o.getElement(e,r),ae(r,r,n),o.setElement(e,r);return e.setInverseBindMatrices(o)}function cn(e,t){var n,o,r;if(!e.getAttribute("TRANSLATION")&&!e.getAttribute("ROTATION")&&!e.getAttribute("SCALE"))return e;const s=null==(n=(e=e.clone()).getAttribute("TRANSLATION"))?void 0:n.clone(),a=null==(o=e.getAttribute("ROTATION"))?void 0:o.clone(),c=null==(r=e.getAttribute("SCALE"))?void 0:r.clone(),l=s||a||c,g=[0,0,0],u=[0,0,0,1],f=[1,1,1],p=[0,0,0],m=[0,0,0,1],d=[1,1,1],h=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],A=mn(t);for(let e=0,t=l.getCount();e<t;e++)i.compose(s?s.getElement(e,p):g,a?a.getElement(e,m):u,c?c.getElement(e,d):f,h),ae(h,h,A),i.decompose(h,p,m,d),s&&s.setElement(e,p),a&&a.setElement(e,m),c&&c.setElement(e,d);return s&&e.setAttribute("TRANSLATION",s),a&&e.setAttribute("ROTATION",a),c&&e.setAttribute("SCALE",c),e}function ln(e,t){for(const n of e.listPrimitives()){let e=n.getMaterial();if(!e)continue;let o=e.getExtension("KHR_materials_volume");!o||o.getThicknessFactor()<=0||(o=o.clone().setThicknessFactor(o.getThicknessFactor()*t),e=e.clone().setExtension("KHR_materials_volume",o),n.setMaterial(e))}}function gn(e,t,n){const o=new t(e.getArray().length),r=Kt.includes(t)?1:0,s=n-r,i=8*t.BYTES_PER_ELEMENT-r,a=Math.pow(2,s)-1,c=i-s,l=2*s-i;for(let t=0,n=0,r=[];t<e.getCount();t++){e.getElement(t,r);for(let e=0;e<r.length;e++){let t=Math.round(Math.abs(r[e])*a);t=t<<c|t>>l,o[n++]=t*Math.sign(r[e])}}e.setArray(o).setNormalized(!0).setSparse(!1)}function un(e,t,n,o){const r=t.getMinNormalized([]),s=t.getMaxNormalized([]);let i,a;if("POSITION"===e)i=o.quantizePosition,a=i<=8?Int8Array:Int16Array;else if("NORMAL"===e||"TANGENT"===e)i=o.quantizeNormal,a=i<=8?Int8Array:Int16Array;else if(e.startsWith("COLOR_"))i=o.quantizeColor,a=i<=8?Uint8Array:Uint16Array;else if(e.startsWith("TEXCOORD_")){if(r.some(e=>e<0)||s.some(e=>e>1))return n.warn(`${Xt}: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=o.quantizeTexcoord,a=i<=8?Uint8Array:Uint16Array}else{if(e.startsWith("JOINTS_"))return i=Math.max(...t.getMax([]))<=255?8:16,a=i<=8?Uint8Array:Uint16Array,t.getComponentSize()>i/8&&t.setArray(new a(t.getArray())),{bits:-1};if(e.startsWith("WEIGHTS_")){if(r.some(e=>e<0)||s.some(e=>e>1))return n.warn(`${Xt}: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=o.quantizeWeight,a=i<=8?Uint8Array:Uint16Array}else{if(!e.startsWith("_"))throw new Error(`${Xt}: Unexpected semantic, "${e}".`);if(r.some(e=>e<-1)||s.some(e=>e>1))return n.warn(`${Xt}: Skipping ${e}; out of [-1,1] range.`),{bits:-1};i=o.quantizeGeneric,a=a=r.some(e=>e<0)?i<=8?Int8Array:Int16Array:i<=8?Uint8Array:Uint16Array}}return{bits:i,ctor:a}}function fn(e){const t=[],n=[];for(const o of e.listPrimitives()){const e=o.getAttribute("POSITION");e&&t.push(e);for(const e of o.listTargets()){const t=e.getAttribute("POSITION");t&&n.push(t)}}if(0===t.length)throw new Error(`${Xt}: Missing "POSITION" attribute.`);const o=pn(t,3);if(n.length>0){const{min:e,max:t}=pn(n,3);le(o.min,o.min,le(e,ue(e,e,2),[0,0,0])),ge(o.max,o.max,ge(t,ue(t,t,2),[0,0,0]))}return o}function pn(e,t){const n=new Array(t).fill(Infinity),o=new Array(t).fill(-Infinity),r=[],s=[];for(const i of e){i.getMinNormalized(r),i.getMaxNormalized(s);for(let e=0;e<t;e++)n[e]=Math.min(n[e],r[e]),o[e]=Math.max(o[e],s[e])}return{min:n,max:o}}function mn(e){return o=e.offset,f=(s=(n=[0,0,0,1])[0])*(l=s+s),p=s*(g=(i=n[1])+i),m=s*(u=(a=n[2])+a),h=i*u,T=(c=n[3])*l,y=c*g,E=c*u,M=(r=[e.scale,e.scale,e.scale])[1],I=r[2],(t=[])[0]=(1-((d=i*g)+(A=a*u)))*(S=r[0]),t[1]=(p+E)*S,t[2]=(m-y)*S,t[3]=0,t[4]=(p-E)*M,t[5]=(1-(f+A))*M,t[6]=(h+T)*M,t[7]=0,t[8]=(m+y)*I,t[9]=(h-T)*I,t[10]=(1-(f+d))*I,t[11]=0,t[12]=o[0],t[13]=o[1],t[14]=o[2],t[15]=1,t;var t,n,o,r,s,i,a,c,l,g,u,f,p,m,d,h,A,T,y,E,S,M,I}const dn={level:"high"},hn="meshopt";function An(e){const t=q({},dn,e),n=t.encoder;if(!n)throw new Error(`${hn}: encoder dependency required — install "meshoptimizer".`);return B(hn,async e=>{await e.transform(Wt({encoder:n,target:"size"}),nn({pattern:"medium"===t.level?/.*/:/^(POSITION|TEXCOORD|JOINTS|WEIGHTS)(_\d+)?$/,quantizePosition:14,quantizeTexcoord:12,quantizeColor:8,quantizeNormal:8})),e.createExtension(R).setRequired(!0).setEncoderOptions({method:"medium"===t.level?R.EncoderMethod.QUANTIZE:R.EncoderMethod.FILTER})})}const Tn="metalRough",yn={};function En(e=yn){return q({},yn,e),B(Tn,async e=>{const t=e.getLogger();if(!e.getRoot().listExtensionsUsed().map(e=>e.extensionName).includes("KHR_materials_pbrSpecularGlossiness"))return void t.warn(`${Tn}: KHR_materials_pbrSpecularGlossiness not found on document.`);const n=e.createExtension(C),o=e.createExtension(O),r=e.createExtension($),s=new Set;for(const t of e.getRoot().listMaterials()){const r=t.getExtension("KHR_materials_pbrSpecularGlossiness");if(!r)continue;const i=o.createSpecular().setSpecularFactor(1).setSpecularColorFactor(r.getSpecularFactor());s.add(r.getSpecularGlossinessTexture()),s.add(t.getBaseColorTexture()),s.add(t.getMetallicRoughnessTexture()),t.setBaseColorFactor(r.getDiffuseFactor()).setMetallicFactor(0).setRoughnessFactor(1).setExtension("KHR_materials_ior",n.createIOR().setIOR(1e3)).setExtension("KHR_materials_specular",i);const a=r.getDiffuseTexture();a&&(t.setBaseColorTexture(a),t.getBaseColorTextureInfo().copy(r.getDiffuseTextureInfo()));const c=r.getSpecularGlossinessTexture();if(c){const n=r.getSpecularGlossinessTextureInfo(),o=e.createTexture();await W(c,o,(e,t,n)=>{e.set(t,n,3,255)}),i.setSpecularTexture(o),i.setSpecularColorTexture(o),i.getSpecularTextureInfo().copy(n),i.getSpecularColorTextureInfo().copy(n);const s=r.getGlossinessFactor(),a=e.createTexture();await W(c,a,(e,t,n)=>{const o=255-Math.round(e.get(t,n,3)*s);e.set(t,n,0,0),e.set(t,n,1,o),e.set(t,n,2,0),e.set(t,n,3,255)}),t.setMetallicRoughnessTexture(a),t.getMetallicRoughnessTextureInfo().copy(n)}else i.setSpecularColorFactor(r.getSpecularFactor()),t.setRoughnessFactor(1-r.getGlossinessFactor());t.setExtension("KHR_materials_pbrSpecularGlossiness",null)}r.dispose();for(const e of s)e&&1===e.listParents().length&&e.dispose();t.debug(`${Tn}: Complete.`)})}const Sn="unweld",Mn={};function In(e=Mn){return q({},Mn,e),B(Sn,e=>{const t=e.getLogger(),n=new Map;for(const o of e.getRoot().listMeshes())for(const e of o.listPrimitives()){const o=e.getIndices();if(!o)continue;const r=e.getAttribute("POSITION").getCount();for(const r of e.listAttributes())e.swap(r,wn(r,o,t,n)),1===r.listParents().length&&r.dispose();for(const r of e.listTargets())for(const e of r.listAttributes())r.swap(e,wn(e,o,t,n)),1===e.listParents().length&&e.dispose();const s=e.getAttribute("POSITION").getCount();t.debug(`${Sn}: ${X(r,s)} vertices.`),e.setIndices(null),1===o.listParents().length&&o.dispose()}t.debug(`${Sn}: Complete.`)})}function wn(e,t,n,o){if(o.has(e)&&o.get(e).has(t))return n.debug(`${Sn}: Cache hit for reused attribute, "${e.getName()}".`),o.get(e).get(t);const r=e.clone(),s=e.getArray().constructor;r.setArray(new s(t.getCount()*e.getElementSize()));const i=[];for(let n=0;n<t.getCount();n++)r.setElement(n,e.getElement(t.getScalar(n),i));return o.has(e)||o.set(e,new Map),o.get(e).set(t,r),r}const bn="normals",Nn={overwrite:!1};function Rn(e=Nn){const t=q({},Nn,e);return B(bn,async e=>{const n=e.getLogger();let o=0;await e.transform(In());for(const r of e.getRoot().listMeshes())for(const s of r.listPrimitives()){const r=s.getAttribute("POSITION");let i=s.getAttribute("NORMAL");if(t.overwrite&&i)i.dispose();else if(i){n.debug(`${bn}: Skipping primitive: NORMAL found.`);continue}i=e.createAccessor().setArray(new Float32Array(3*r.getCount())).setType("VEC3");const a=[0,0,0],c=[0,0,0],l=[0,0,0];for(let e=0;e<r.getCount();e+=3){r.getElement(e+0,a),r.getElement(e+1,c),r.getElement(e+2,l);const t=Cn(a,c,l);i.setElement(e+0,t),i.setElement(e+1,t),i.setElement(e+2,t)}s.setAttribute("NORMAL",i),o++}o?n.debug(`${bn}: Complete.`):n.warn(`${bn}: No qualifying primitives found. See debug output.`)})}function Cn(e,t,n){const o=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],r=[n[0]-e[0],n[1]-e[1],n[2]-e[2]];return fe([0,0,0],[o[1]*r[2]-o[2]*r[1],o[2]*r[0]-o[0]*r[2],o[0]*r[1]-o[1]*r[0]])}const On="palette",$n={blockSize:4,min:2};function vn(e=$n){const n=q({},$n,e),o=Math.max(n.blockSize,1),r=Math.max(n.min,1);return B(On,async e=>{const n=e.getLogger(),s=e.getRoot();await e.transform(_e({keepAttributes:!1,keepLeaves:!0,propertyTypes:[t.ACCESSOR]}));const i=new Set,a=new Set;for(const e of s.listMeshes())for(const t of e.listPrimitives()){const e=t.getMaterial();e&&!t.getAttribute("TEXCOORD_0")&&(i.add(t),a.add(e))}const c=new Set,g=new Map,u={baseColor:new Set,emissive:new Set,metallicRoughness:new Set};for(const e of a){const t=xn(e.getBaseColorFactor().slice()),n=xn([...e.getEmissiveFactor(),1]),o=Pn(e.getRoughnessFactor()),r=Pn(e.getMetallicFactor()),s=`baseColor:${t},emissive:${n},metallicRoughness:${r}${o}`;u.baseColor.add(t),u.emissive.add(n),u.metallicRoughness.add(r+"+"+o),c.add(s),g.set(e,s)}const f=c.size;if(f<r)return void n.debug(`${On}: Found <${r} unique material properties. Exiting.`);const p=Ln(f*o),m=Ln(o),d=p-f*o,h={baseColor:null,emissive:null,metallicRoughness:null},A=new Set(["name","extras"]),T=(...e)=>e.forEach(e=>A.add(e));let E=null,S=null,M=null;if(u.baseColor.size>=r){const t="PaletteBaseColor";E=e.createTexture(t).setURI(`${t}.png`),h.baseColor=_(new Uint8Array(p*m*4),[p,m,4]),T("baseColorFactor","baseColorTexture","baseColorTextureInfo")}if(u.emissive.size>=r){const t="PaletteEmissive";S=e.createTexture(t).setURI(`${t}.png`),h.emissive=_(new Uint8Array(p*m*4),[p,m,4]),T("emissiveFactor","emissiveTexture","emissiveTextureInfo")}if(u.metallicRoughness.size>=r){const t="PaletteMetallicRoughness";M=e.createTexture(t).setURI(`${t}.png`),h.metallicRoughness=_(new Uint8Array(p*m*4),[p,m,4]),T("metallicFactor","roughnessFactor","metallicRoughnessTexture","metallicRoughnessTextureInfo")}if(!(E||S||M))return void n.debug(`${On}: No material property has ≥${r} unique values. Exiting.`);const w=new Set,b=new Map,N=[];let R=0;for(const e of a){const t=g.get(e);if(w.has(t))continue;const n=R++;if(h.baseColor){const t=h.baseColor,r=[...e.getBaseColorFactor()];y.convertLinearToSRGB(r,r),zn(t,n,r,o)}if(h.emissive){const t=h.emissive,r=[...e.getEmissiveFactor(),1];y.convertLinearToSRGB(r,r),zn(t,n,r,o)}if(h.metallicRoughness){const t=h.metallicRoughness,r=e.getMetallicFactor();zn(t,n,[0,e.getRoughnessFactor(),r,1],o)}w.add(t),b.set(t,n)}const C="image/png";if(E){const e=await I(h.baseColor,C);E.setImage(e).setMimeType(C)}if(S){const e=await I(h.emissive,C);S.setImage(e).setMimeType(C)}if(M){const e=await I(h.metallicRoughness,C);M.setImage(e).setMimeType(C)}let O=1;for(const t of i){const n=t.getMaterial(),o=g.get(n),r=(b.get(o)+.5)/f*(p-d)/p,s=t.getAttribute("POSITION"),i=s.getBuffer(),a=new Float32Array(2*s.getCount()).fill(r),c=e.createAccessor().setType("VEC2").setArray(a).setBuffer(i);let u;for(const e of N)e.equals(n,A)&&(u=e);if(!u){const e=(O++).toString().padStart(3,"0");u=n.clone().setName(`PaletteMaterial${e}`),E&&u.setBaseColorFactor([1,1,1,1]).setBaseColorTexture(E).getBaseColorTextureInfo().setMinFilter(l.MinFilter.NEAREST).setMagFilter(l.MagFilter.NEAREST),S&&u.setEmissiveFactor([1,1,1]).setEmissiveTexture(S).getEmissiveTextureInfo().setMinFilter(l.MinFilter.NEAREST).setMagFilter(l.MagFilter.NEAREST),M&&u.setMetallicFactor(1).setRoughnessFactor(1).setMetallicRoughnessTexture(M).getMetallicRoughnessTextureInfo().setMinFilter(l.MinFilter.NEAREST).setMagFilter(l.MagFilter.NEAREST),N.push(u)}t.setMaterial(u).setAttribute("TEXCOORD_0",c)}await e.transform(_e({propertyTypes:[t.MATERIAL]})),n.debug(`${On}: Complete.`)})}function Pn(e){const t=Math.round(255*e).toString(16);return 1===t.length?"0"+t:t}function xn(e){return y.convertLinearToSRGB(e,e),e.map(Pn).join("")}function Ln(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function zn(e,t,n,o){for(let r=0;r<o;r++)for(let s=0;s<o;s++)e.set(t*o+r,s,0,255*n[0]),e.set(t*o+r,s,1,255*n[1]),e.set(t*o+r,s,2,255*n[2]),e.set(t*o+r,s,3,255*n[3])}const Fn="partition",_n={animations:!0,meshes:!0};function Gn(e=_n){const n=q({},_n,e);return B(Fn,async e=>{const o=e.getLogger();!1!==n.meshes&&function(e,t,n){const o=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listMeshes().forEach((r,s)=>{if(Array.isArray(n.meshes)&&!n.meshes.includes(r.getName()))return void t.debug(`${Fn}: Skipping mesh #${s} with name "${r.getName()}".`);t.debug(`${Fn}: Creating buffer for mesh "${r.getName()}".`);const i=e.createBuffer(r.getName()).setURI(kn(r.getName()||"mesh",o));r.listPrimitives().forEach(e=>{const t=e.getIndices();t&&t.setBuffer(i),e.listAttributes().forEach(e=>e.setBuffer(i)),e.listTargets().forEach(e=>{e.listAttributes().forEach(e=>e.setBuffer(i))})})})}(e,o,n),!1!==n.animations&&function(e,t,n){const o=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listAnimations().forEach((r,s)=>{if(Array.isArray(n.animations)&&!n.animations.includes(r.getName()))return void t.debug(`${Fn}: Skipping animation #${s} with name "${r.getName()}".`);t.debug(`${Fn}: Creating buffer for animation "${r.getName()}".`);const i=e.createBuffer(r.getName()).setURI(kn(r.getName()||"animation",o));r.listSamplers().forEach(e=>{const t=e.getInput(),n=e.getOutput();t&&t.setBuffer(i),n&&n.setBuffer(i)})})}(e,o,n),n.meshes||n.animations||o.warn(`${Fn}: Select animations or meshes to create a partition.`),await e.transform(_e({propertyTypes:[t.BUFFER]})),o.debug(`${Fn}: Complete.`)})}function kn(e,t){let n=`${e}.bin`,o=1;for(;t.has(n);)n=`${e}_${o++}.bin`;return n}var qn;function Bn(e,t,n){for(let o=0,r=n.length;o<r;o++)n[o]=e[t*r+o];return n}function Un(e,t,n){for(let o=0,r=n.length;o<r;o++)e[t*r+o]=n[o]}function Wn(e,t,n=0){if(e.length!==t.length)return!1;for(let o=0;o<e.length;o++)if(Math.abs(e[o]-t[o])>n)return!1;return!0}function Dn(e,t,n){return e*(1-n)+t*n}function Hn(e,t,n,o){for(let r=0;r<t.length;r++)e[r]=Dn(t[r],n[r],o);return e}function jn(e,t,n,o){let r,s,i,a,c,l=t[0],g=t[1],u=t[2],f=t[3],p=n[0],m=n[1],d=n[2],h=n[3];return s=l*p+g*m+u*d+f*h,s<0&&(s=-s,p=-p,m=-m,d=-d,h=-h),1-s>1e-6?(r=Math.acos(s),i=Math.sin(r),a=Math.sin((1-o)*r)/i,c=Math.sin(o*r)/i):(a=1-o,c=o),e[0]=a*l+c*p,e[1]=a*g+c*m,e[2]=a*u+c*d,e[3]=a*f+c*h,e}function Vn(e,t){const n=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}(e,t);return Math.acos(2*n*n-1)}!function(e){e[e.STEP=0]="STEP",e[e.LERP=1]="LERP",e[e.SLERP=2]="SLERP"}(qn||(qn={}));const Xn="resample",Kn=new Float32Array(0),Jn={ready:Promise.resolve(),resample:function(e,t,n,o=1e-4){const r=t.length/e.length,s=new Array(r).fill(0),i=new Array(r).fill(0),a=new Array(r).fill(0),c=new Array(r).fill(0),l=e.length-1;let g=1;for(let r=1;r<l;++r){const l=e[g-1],u=e[r],f=e[r+1],p=(u-l)/(f-l);let m=!1;if(u!==f&&(1!==r||u!==e[0]))if(Bn(t,g-1,c),Bn(t,r,i),Bn(t,r+1,a),"slerp"===n){const e=jn(s,c,a,p),t=Vn(c,i)+Vn(i,a);m=!Wn(i,e,o)||t+Number.EPSILON>=Math.PI}else"lerp"===n?m=!Wn(i,Hn(s,c,a,p),o):"step"===n&&(m=!Wn(i,c)||!Wn(i,a));m&&(r!==g&&(e[g]=e[r],Un(t,g,Bn(t,r,s))),g++)}return l>0&&(e[g]=e[l],Un(t,g,Bn(t,l,s)),g++),g},tolerance:1e-4};function Zn(e=Jn){const n=q({},Jn,e);return B(Xn,async(e,o)=>{const r=new Set,s=e.getRoot().listAccessors().length,i=e.getLogger(),a=n.ready,l=n.resample;await a;for(const t of e.getRoot().listAnimations()){const e=new Map;for(const n of t.listChannels())e.set(n.getSampler(),n.getTargetPath());for(const o of t.listSamplers()){const t=o.getInterpolation();if("STEP"===t||"LINEAR"===t){const s=o.getInput(),i=o.getOutput();r.add(s),r.add(i);const a=Qn(s.getArray(),s.getComponentType(),s.getNormalized()),c=Qn(i.getArray(),i.getComponentType(),i.getNormalized()),g=c.length/a.length,u=a.length;let f;if(f="STEP"===t?l(a,c,"step",n.tolerance):"rotation"===e.get(o)?l(a,c,"slerp",n.tolerance):l(a,c,"lerp",n.tolerance),f<u){const e=s.getArray(),t=i.getArray(),n=Yn(new Float32Array(a.buffer,a.byteOffset,f),s.getComponentType(),s.getNormalized()),r=Yn(new Float32Array(c.buffer,c.byteOffset,f*g),i.getComponentType(),i.getNormalized());s.setArray(Kn),i.setArray(Kn),o.setInput(s.clone().setArray(n)),o.setOutput(i.clone().setArray(r)),s.setArray(e),i.setArray(t)}}}}for(const e of Array.from(r.values()))e.listParents().some(e=>!(e instanceof c))||e.dispose();e.getRoot().listAccessors().length>s&&!U(o,Xn,"dedup")&&await e.transform(be({propertyTypes:[t.ACCESSOR]})),i.debug(`${Xn}: Complete.`)})}function Qn(e,t,n){if(e instanceof Float32Array)return e.slice();const o=new Float32Array(e);if(!n)return o;for(let e=0;e<o.length;e++)o[e]=i.decodeNormalizedInt(o[e],t);return o}function Yn(e,t,n){if(t===p.ComponentType.FLOAT)return e.slice();const o=new(0,d[t])(e.length);for(let r=0;r<o.length;r++)o[r]=n?i.encodeNormalizedInt(e[r],t):e[r];return o}const eo="sequence",to={name:"",fps:10,pattern:/.*/,sort:!0};function no(e=to){const t=q({},to,e);return B(eo,e=>{const n=e.getLogger(),o=e.getRoot(),r=t.fps,s=o.listNodes().filter(e=>e.getName().match(t.pattern));t.sort&&s.sort((e,t)=>e.getName()>t.getName()?1:-1);const i=e.createAnimation(t.name),a=o.listBuffers()[0];s.forEach((t,n)=>{let o,c;0===n?(o=[n/r,(n+1)/r],c=[1,1,1,0,0,0]):n===s.length-1?(o=[(n-1)/r,n/r],c=[0,0,0,1,1,1]):(o=[(n-1)/r,n/r,(n+1)/r],c=[0,0,0,1,1,1,0,0,0]);const l=e.createAccessor().setArray(new Float32Array(o)).setBuffer(a),g=e.createAccessor().setArray(new Float32Array(c)).setBuffer(a).setType(p.Type.VEC3),u=e.createAnimationSampler().setInterpolation(E.Interpolation.STEP).setInput(l).setOutput(g),m=e.createAnimationChannel().setTargetNode(t).setTargetPath(f.TargetPath.SCALE).setSampler(u);i.addSampler(u).addChannel(m)}),n.debug(`${eo}: Complete.`)})}const oo="simplify",ro={ratio:0,error:1e-4,lockBorder:!1};function so(n){const o=q({},ro,n),r=o.simplifier;if(!r)throw new Error(`${oo}: simplifier dependency required — install "meshoptimizer".`);return B(oo,async(n,s)=>{const i=n.getLogger();await r.ready,await n.transform(De({overwrite:!1}));for(const t of n.getRoot().listMeshes())for(const r of t.listPrimitives())r.getMode()===e.Mode.TRIANGLES?io(n,r,o):i.warn(`${oo}: Skipping primitive of mesh "${t.getName()}": Requires TRIANGLES draw mode.`);U(s,oo,"dedup")||await n.transform(be({propertyTypes:[t.ACCESSOR]})),i.debug(`${oo}: Complete.`)})}function io(e,t,n){const o=q({},ro,n),r=o.simplifier,s=e.getLogger(),i=t.getAttribute("POSITION"),a=t.getIndices(),c=i.getCount();let l=i.getArray(),g=a.getArray();if(i.getComponentType()!==p.ComponentType.FLOAT)if(i.getNormalized()){const e=l,t=new Float32Array(e.length);for(let n=0,o=i.getCount(),r=[];n<o;n++)r=i.getElement(n,r),i.setArray(t).setElement(n,r).setArray(e);l=t}else l=new Float32Array(l);a.getComponentType()!==p.ComponentType.UNSIGNED_INT&&(g=new Uint32Array(g));const u=3*Math.floor(o.ratio*c/3),[f,m]=r.simplify(g,l,3,u,o.error,o.lockBorder?["LockBorder"]:[]),[d,h]=r.compactMesh(f);s.debug(`${oo}: ${X(i.getCount(),h)} vertices, error: ${m.toFixed(4)}.`);for(const e of K(t)){const n=e.clone();Z(n,d,h),J(t,e,n),1===e.listParents().length&&e.dispose()}const A=a.clone();return A.setArray(c<=65534?new Uint16Array(f):f),t.setIndices(A),1===a.listParents().length&&a.dispose(),t}const ao="sparse",co={ratio:1/3};function lo(e=co){const t=q({},co,e).ratio;if(t<0||t>1)throw new Error(`${ao}: Ratio must be between 0 and 1.`);return B(ao,e=>{const n=e.getRoot(),o=e.getLogger();let r=0;for(const e of n.listAccessors()){const n=e.getCount(),o=Array(e.getElementSize()).fill(0),s=Array(e.getElementSize()).fill(0);let a=0;for(let r=0;r<n&&(e.getElement(r,s),i.eq(s,o,0)||a++,!(a/n>=t));r++);const c=a/n<t;c!==e.getSparse()&&(e.setSparse(c),r++)}o.debug(`${ao}: Updated ${r} accessors.`),o.debug(`${ao}: Complete.`)})}const go="textureResize";var uo;!function(e){e.LANCZOS3="lanczos3",e.LANCZOS2="lanczos2"}(uo||(uo={}));const fo={size:[2048,2048],filter:uo.LANCZOS3,pattern:null,slots:null};function po(e=fo){const t=q({},fo,e);return B(go,async e=>{const n=e.getLogger();for(const o of e.getRoot().listTextures()){const e=o.getName(),r=o.getURI();if(t.pattern&&!t.pattern.test(e)&&!t.pattern.test(r)){n.debug(`${go}: Skipping, excluded by "pattern" parameter.`);continue}if("image/png"!==o.getMimeType()&&"image/jpeg"!==o.getMimeType()){n.warn(`${go}: Skipping, unsupported texture type "${o.getMimeType()}".`);continue}const s=qt(o);if(t.slots&&!s.some(e=>{var n;return null==(n=t.slots)?void 0:n.test(e)})){n.debug(`${go}: Skipping, [${s.join(", ")}] excluded by "slots" parameter.`);continue}const[i,a]=t.size,[c,l]=o.getSize();if(c<=i&&l<=a){n.debug(`${go}: Skipping, not within size range.`);continue}let g=c,u=l;g>i&&(u=Math.floor(u*(i/g)),g=i),u>a&&(g=Math.floor(g*(a/u)),u=a);const f=o.getImage(),p=await M(f,o.getMimeType()),m=_(new Uint8Array(g*u*4),[g,u,4]);n.debug(`${go}: Resizing "${r||e}", ${p.shape} → ${m.shape}...`),n.debug(`${go}: Slots → [${s.join(", ")}]`);try{t.filter===uo.LANCZOS3?G(p,m):k(p,m)}catch(t){if(t instanceof Error){n.warn(`${go}: Failed to resize "${r||e}": "${t.message}".`);continue}throw t}o.setImage(await I(m,o.getMimeType()))}n.debug(`${go}: Complete.`)})}const mo="textureCompress",ho=["jpeg","png","webp","avif"],Ao=["image/jpeg","image/png","image/webp","image/avif"],To={resizeFilter:uo.LANCZOS3,pattern:null,formats:null,slots:null,quality:null,effort:null,lossless:!1,nearLossless:!1};function yo(e){const t=q({},To,e),n=t.targetFormat,o=t.pattern,r=t.formats,s=t.slots;if(!t.encoder)throw new Error(`${n}: encoder dependency required — install "sharp".`);return B(mo,async e=>{const i=e.getLogger(),a=e.getRoot().listTextures();await Promise.all(a.map(async(a,c)=>{const l=qt(a),g=kt(a),u=a.getURI()||a.getName()||`${c+1}/${e.getRoot().listTextures().length}`,f=`${mo}(${u})`;if(!Ao.includes(a.getMimeType()))return void i.debug(`${f}: Skipping, unsupported texture type "${a.getMimeType()}".`);if(o&&!o.test(a.getName())&&!o.test(a.getURI()))return void i.debug(`${f}: Skipping, excluded by "pattern" parameter.`);if(r&&!r.test(a.getMimeType()))return void i.debug(`${f}: Skipping, "${a.getMimeType()}" excluded by "formats" parameter.`);if(s&&l.length&&!l.some(e=>s.test(e)))return void i.debug(`${f}: Skipping, [${l.join(", ")}] excluded by "slots" parameter.`);if("jpeg"===t.targetFormat&&g&h.A)return void i.warn(`${f}: Skipping, [${l.join(", ")}] requires alpha channel.`);const p=So(a);i.debug(`${f}: Format = ${p} → ${n||p}`),i.debug(`${f}: Slots = [${l.join(", ")}]`);const m=a.getImage(),d=m.byteLength;await Eo(a,t);const A=a.getImage(),T=A.byteLength,y=m===A?" (SKIPPED":"";i.debug(`${f}: Size = ${j(d)} → ${j(T)}${y}`)}));const c=e.createExtension(v);a.some(e=>"image/webp"===e.getMimeType())?c.setRequired(!0):c.dispose();const l=e.createExtension(P);a.some(e=>"image/avif"===e.getMimeType())?l.setRequired(!0):l.dispose(),i.debug(`${mo}: Complete.`)})}async function Eo(e,t){const n=q({},To,t),o=n.encoder;if(!o)throw new Error(`${n.targetFormat}: encoder dependency required — install "sharp".`);const r=So(e),s=n.targetFormat||r,i=e.getMimeType(),c=`image/${s}`;let l={};switch(s){case"jpeg":l={quality:n.quality};break;case"png":l={quality:n.quality,effort:Mo(n.effort,100,10)};break;case"webp":l={quality:n.quality,effort:Mo(n.effort,100,6),lossless:n.lossless,nearLossless:n.nearLossless};break;case"avif":l={quality:n.quality,effort:Mo(n.effort,100,9),lossless:n.lossless}}const g=e.getImage(),u=o(g).toFormat(s,l);n.resize&&u.resize(n.resize[0],n.resize[1],{fit:"inside",kernel:n.resizeFilter,withoutEnlargement:!0});const f=a.toView(await u.toBuffer());if(!(i===c&&f.byteLength>=g.byteLength))if(i===c)e.setImage(f);else{const t=m.mimeTypeToExtension(i),n=m.mimeTypeToExtension(c),o=e.getURI().replace(new RegExp(`\\.${t}$`),`.${n}`);e.setImage(f).setMimeType(c).setURI(o)}}function So(e){const t=e.getMimeType(),n=t.split("/").pop();if(!n||!ho.includes(n))throw new Error(`Unknown MIME type "${t}".`);return n}function Mo(e,t,n){return null==e?null:Math.round(e/t*n)}const Io="tangents",wo={overwrite:!1};function bo(e=wo){if(!e.generateTangents)throw new Error(`${Io}: generateTangents callback required — install "mikktspace".`);const t=q({},wo,e);return B(Io,e=>{const n=e.getLogger(),o=new Map,r=new Map;let s=0;for(const i of e.getRoot().listMeshes()){const a=i.getName(),c=i.listPrimitives();for(let i=0;i<c.length;i++){const l=c[i];if(!Ro(l,n,a,i,t.overwrite))continue;const g=No(l),u=l.getAttribute("POSITION").getArray(),f=l.getAttribute("NORMAL").getArray(),p=l.getAttribute(g).getArray(),m=o.get(u)||S();o.set(u,m);const d=o.get(f)||S();o.set(f,d);const h=o.get(p)||S();o.set(p,h);const A=l.getAttribute("TANGENT");A&&2===A.listParents().length&&A.dispose();const T=`${m}|${d}|${h}`;let y=r.get(T);if(y){n.debug(`${Io}: Found cache for primitive ${i} of mesh "${a}".`),l.setAttribute("TANGENT",y),s++;continue}n.debug(`${Io}: Generating for primitive ${i} of mesh "${a}".`);const E=l.getAttribute("POSITION").getBuffer(),M=t.generateTangents(u instanceof Float32Array?u:new Float32Array(u),f instanceof Float32Array?f:new Float32Array(f),p instanceof Float32Array?p:new Float32Array(p));for(let e=3;e<M.length;e+=4)M[e]*=-1;y=e.createAccessor().setBuffer(E).setArray(M).setType("VEC4"),l.setAttribute("TANGENT",y),r.set(T,y),s++}}s?n.debug(`${Io}: Complete.`):n.warn(`${Io}: No qualifying primitives found. See debug output.`)})}function No(e){const t=e.getMaterial();if(!t)return"TEXCOORD_0";const n=t.getNormalTextureInfo();if(!n)return"TEXCOORD_0";const o=`TEXCOORD_${n.getTexCoord()}`;return e.getAttribute(o)?o:"TEXCOORD_0"}function Ro(t,n,o,r,s){return t.getMode()===e.Mode.TRIANGLES&&t.getAttribute("POSITION")&&t.getAttribute("NORMAL")&&t.getAttribute("TEXCOORD_0")?t.getAttribute("TANGENT")&&!s?(n.debug(`${Io}: Skipping primitive ${r} of mesh "${o}": TANGENT found.`),!1):!t.getIndices()||(n.warn(`${Io}: Skipping primitive ${r} of mesh "${o}": primitives must be unwelded.`),!1):(n.debug(`${Io}: Skipping primitive ${r} of mesh "${o}": primitives must have attributes=[POSITION, NORMAL, TEXCOORD_0] and mode=TRIANGLES.`),!1)}function Co(){return e=>{const t=e.createExtension(x).createUnlit();e.getRoot().listMaterials().forEach(e=>{e.setExtension("KHR_materials_unlit",t)})}}const Oo="unpartition",$o={};function vo(e=$o){return q({},$o,e),B(Oo,async e=>{const t=e.getLogger(),n=e.getRoot().listBuffers()[0];e.getRoot().listAccessors().forEach(e=>e.setBuffer(n)),e.getRoot().listBuffers().forEach((e,t)=>t>0?e.dispose():null),t.debug(`${Oo}: Complete.`)})}const Po="vertexColorSpace",xo=Lo;function Lo(e){return B(Po,t=>{const n=t.getLogger(),o=(e.inputColorSpace||e.inputEncoding||"").toLowerCase();if("srgb-linear"===o)return void n.info(`${Po}: Vertex colors already linear. Skipping conversion.`);if("srgb"!==o)return void n.error(`${Po}: Unknown input color space "${o}" – should be "srgb" or "srgb-linear". Skipping conversion.`);const r=new Set;function s(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function i(e){const t=[0,0,0];let n;for(let o=0;n=e.getAttribute(`COLOR_${o}`);o++)if(!r.has(n)){for(let e=0;e<n.getCount();e++)n.getElement(e,t),t[0]=s(t[0]),t[1]=s(t[1]),t[2]=s(t[2]),n.setElement(e,t);r.add(n)}}t.getRoot().listMeshes().forEach(e=>e.listPrimitives().forEach(i)),n.debug(`${Po}: Complete.`)})}export{et as DRACO_DEFAULTS,ot as FLATTEN_DEFAULTS,xt as JOIN_DEFAULTS,dn as MESHOPT_DEFAULTS,$n as PALETTE_DEFAULTS,tn as QUANTIZE_DEFAULTS,ro as SIMPLIFY_DEFAULTS,To as TEXTURE_COMPRESS_DEFAULTS,fo as TEXTURE_RESIZE_DEFAULTS,uo as TextureResizeFilter,We as WELD_DEFAULTS,ne as center,re as clearNodeParent,Me as clearNodeTransform,xo as colorspace,Eo as compressTexture,B as createTransform,be as dedup,$e as dequantize,tt as draco,rt as flatten,D as getGLPrimitiveCount,st as getNodeScene,kt as getTextureChannelMask,at as getTextureColorSpace,ct as inspect,Et as instance,U as isTransformPending,Lt as join,wt as joinPrimitives,oe as listNodeScenes,Gt as listTextureChannels,xe as listTextureInfo,Le as listTextureInfoByMaterial,qt as listTextureSlots,An as meshopt,En as metalRough,Rn as normals,vn as palette,Gn as partition,_e as prune,nn as quantize,Wt as reorder,Zn as resample,no as sequence,so as simplify,io as simplifyPrimitive,Dt as sortPrimitiveWeights,lo as sparse,bo as tangents,yo as textureCompress,po as textureResize,Ee as transformMesh,he as transformPrimitive,Co as unlit,vo as unpartition,In as unweld,Lo as vertexColorSpace,De as weld,He as weldPrimitive};
//# sourceMappingURL=functions.modern.js.map
